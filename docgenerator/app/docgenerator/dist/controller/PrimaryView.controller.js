sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/ColumnListItem","sap/m/ObjectIdentifier","sap/m/Text","sap/m/VBox","sap/m/FormattedText","sap/m/MessageBox"],function(e,t,a,r,n,i,o,s){"use strict";return e.extend("docgenerator.controller.PrimaryView",{onInit:function(){var e=this.getView();var t=e.byId("idDocTable");t.setBusy(true);this._fallbackFetchAndBind();this.aFinalFilters=[]},_bindTableToFunction:function(){var e=this.getView();var t=e.byId("idDocTable");var l=this.getOwnerComponent().getModel();if(!t||!l){s.error("Table or OData V4 model not found.");return}var c="/generate";var u=new a({cells:[new r({title:"{displayName}",text:"{parameterName}"}),new i({items:[new n({text:"{parameterType}"}),new n({text:{parts:[{path:"defaultValue"}],formatter:function(e){return"Default: "+e}}}),new n({text:{parts:[{path:"parameterValue"}],formatter:function(e){return"Value: "+e}}}),new n({text:{parts:[{path:"isDefault"}],formatter:function(e){return e?"Is Default: true":""}}}),new o({htmlText:"{description}"})]})]});t.unbindItems();t.bindItems({path:c,parameters:{operationMode:"Server"},template:u});var d=t.getBinding("items");if(!d){this._fallbackFetchAndBind();return}var m=function(){try{var e=typeof d.getCurrentContexts==="function"?d.getCurrentContexts():[];var t=e&&e.length?e.length:0;if(t===0){d.detachChange(m);this._fallbackFetchAndBind()}else{d.detachChange(m)}}catch(e){d.detachChange(m);this._fallbackFetchAndBind()}}.bind(this);if(typeof d.attachChange==="function"){d.attachChange(m)}else{setTimeout(function(){this._fallbackFetchAndBind()}.bind(this),800)}},onParamNameFilterSelectionFinish:function(e){var t=e.getSource();var a=t.getSelectedItems();var r=a.map(function(e){return e.getKey()});var n=this.getView().byId("idDocTable");var i=n.getBinding("items");if(i){if(r.length>0){var o=r.map(function(e){return new sap.ui.model.Filter("parameterName",sap.ui.model.FilterOperator.EQ,e)});var s=new sap.ui.model.Filter(o,false);i.filter(s)}else{i.filter([])}}},onCustomerEditFilterSelectionFinish:function(e){var t=e.getSource();var a=t.getSelectedItems();var r=a.map(function(e){if(e.getKey()==="true"||e.getKey()===0){return true}else if(e.getKey()==="false"||e.getKey()===1){return false}return e.getKey()});var n=this.getView().byId("idDocTable");var i=n.getBinding("items");if(i){if(r.length>0){var o=r.map(function(e){return new sap.ui.model.Filter("isCustomerEditable",sap.ui.model.FilterOperator.EQ,e);aFinalFilters.push(new sap.ui.model.Filter({filters:o}))});var s=new sap.ui.model.Filter(o,false);i.filter(s)}else{i.filter([])}}},_fallbackFetchAndBind:async function(){var e=this.getView();var r=e.byId("idDocTable");if(!r){s.error("Table not found.");return}var n="/odata/v4/generate-document/generate";await fetch(n,{method:"GET",credentials:"same-origin"}).then(function(e){if(!e.ok){throw new Error("Network response was not ok: "+e.status)}return e.json()}).then(async function(a){var n;if(Array.isArray(a)){n=a}else if(a&&Array.isArray(a.value)){n=a.value}else if(a&&typeof a==="object"){n=[a]}else{n=[]}debugger;var i=new t({items:n});e.setModel(i,"docs");r.setBusy(false);var o=this.getView().getModel("docs");var s=o.getProperty("/items")||[];var l={};var c={};var u=s.reduce(function(e,t){var a=t.isCustomerEditable;if(a!==undefined&&!l[a]){l[a]=true;e.push({key:a,text:String(a)})}return e},[]);var d=await s.reduce(function(e,t){var a=t.parameterName;if(a!==undefined&&!c[a]){c[a]=true;e.push({key:a,text:String(a.replace(/\./g," "))})}return e},[]);var m=new sap.ui.model.json.JSONModel({customerEditableOptions:u,parameterNameOptions:d});this.getView().setModel(m,"filter")}.bind(this)).catch(function(n){s.error(n.message||"Failed to call generate function");var i=new t({items:[]});e.setModel(i,"docs");r.unbindItems();r.bindItems({path:"docs>/items",template:new a})}.bind(this))},onGeneratePress:function(){var e=this.getView();var t=e.byId("idDocTable");t.setBusy(true);var a=this.getView().byId("parameterName").getSelectedItems();var r=a.map(function(e){return e.getKey()});var n=this.getView().byId("isCustomerEditable").getSelectedItems();var i=n.map(function(e){if(e.getKey()==="true"||e.getKey()===0){return true}else if(e.getKey()==="false"||e.getKey()===1){return false}return e.getKey()});var o=r.length>0?r.join(","):" ";var l=i.length===1?i[0]:" ";var c={parameterName:[o],isCustomerEditable:l};var u="/odata/v4/generate-document/getDocumentCreated?params="+encodeURIComponent(JSON.stringify(c));fetch(u,{method:"GET",credentials:"same-origin",headers:{"Content-Type":"application/json"}}).then(async function(e){if(!e.ok){throw new Error("Network response was not ok: "+e.status)}const t=await e.blob();const a=e.headers.get("Content-Disposition")||"";let r="Ariba Config Document.docx";const n=a.match(/filename\\*=?UTF-8''([^;\\n\\r]+)/i);const i=a.match(/filename=\"?([^\";]+)\"?/i);if(n&&n[1])r=decodeURIComponent(n[1]);else if(i&&i[1])r=i[1];const o=URL.createObjectURL(t);const s=document.createElement("a");s.href=o;s.download=r;document.body.appendChild(s);s.click();s.remove();URL.revokeObjectURL(o)}).then(function(e){console.log("Document created: "+e);s.success("Document created: ");t.setBusy(false)}.bind(this)).catch(function(e){s.error(e.message||"Failed to call create document");t.setBusy(false)}.bind(this))}})});
//# sourceMappingURL=PrimaryView.controller.js.map