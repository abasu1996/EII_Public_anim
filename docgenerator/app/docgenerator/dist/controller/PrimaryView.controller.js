sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/ColumnListItem","sap/m/ObjectIdentifier","sap/m/Text","sap/m/VBox","sap/m/FormattedText","sap/m/MessageBox","sap/ui/core/Fragment","sap/m/MessageToast"],function(e,t,n,a,i,r,o,s,l,d){"use strict";return e.extend("docgenerator.controller.PrimaryView",{onInit:function(){this.oView=this.getView();this.oModel=this.getOwnerComponent().getModel();this.aFinalFilters=[]},onFileUpload:function(e){var t=e},onLoadCsvHeaders:function(){debugger;var e=this.getView().byId("csvUploader");var t=e.oFileUpload;var n=t.files[0];if(n){var a=new FileReader;a.onload=function(e){var t=e.target.result;var n=t.split("\n");if(n.length>0){var a=n[0].split(",");var i=a.map(function(e){return{key:e.trim(),text:e.trim()}});var r=new sap.ui.model.json.JSONModel({csvHeaders:i});this.getView().setModel(r,"csv");console.log(i);d.show("CSV headers loaded successfully.")}}.bind(this);a.onerror=function(e){s.error("Error reading file: "+e.target.error.message)}}},onTaxConfigPress:function(){if(!this._oTaxConfigDialog){this._oTaxConfigDialog=sap.ui.xmlfragment("docgenerator.fragments.TaxConfig",this);this.getView().addDependent(this._oTaxConfigDialog)}this._oTaxConfigDialog.open()},onGuidedBuyingPress:function(){var e="docgenerator.fragments.guidedBuying";if(!this._pGuidedBuyingDialog){this._pGuidedBuyingDialog=l.load({name:e,controller:this}).then(function(e){this.getView().addDependent(e);return e}.bind(this)).catch(function(e){console.error("Dialog load error",e);this._pGuidedBuyingDialog=null}.bind(this))}this._pGuidedBuyingDialog.then(function(e){e.open()})},onCloseFieldConfig:function(){var e=this;if(this._pGuidedBuyingDialog){this._pGuidedBuyingDialog.then(function(e){e.close()})}},onFieldConfigPress:function(e){var t=this.getView();var n=this;if(!n._pFieldConfigDialog){n._pFieldConfigDialog=l.load({name:"docgenerator.fragments.FieldConfig",id:t.getId(),controller:this}).then(function(e){t.addDependent(e);return e}).catch(function(e){console.error("FieldConfig fragment load error:",e);d.show("Unable to open Field Configuration (see console).");this._pFieldConfigDialog=null;throw e}.bind(this))}n._pFieldConfigDialog.then(function(e){e.open()}).catch(function(){})},_bindTableToFunction:async function(){var e=this.getView();var t=e.byId("idDocTable");var l=this.getOwnerComponent().getModel();if(!t||!l){s.error("Table or OData V4 model not found.");return}var d="/generate";var c=new n({cells:[new a({title:"{displayName}",text:"{parameterName}"}),new r({items:[new i({text:"{parameterType}"}),new i({text:{parts:[{path:"defaultValue"}],formatter:function(e){return"Default: "+e}}}),new i({text:{parts:[{path:"parameterValue"}],formatter:function(e){return"Value: "+e}}}),new i({text:{parts:[{path:"isDefault"}],formatter:function(e){return e?"Is Default: true":""}}}),new o({htmlText:"{description}"})]})]});var u=await l.bindContext("/generateDocument.generate(...)");await u.invoke();const f=u.getBoundContext()?.getObject();console.log(f);t.bindContext().execute();t.bindItems({path:d,parameters:{operationMode:"Server"},template:c});var g=t.getBinding("items");if(!g){this._fallbackFetchAndBind();return}var p=function(){try{var e=typeof g.getCurrentContexts==="function"?g.getCurrentContexts():[];var t=e&&e.length?e.length:0;if(t===0){g.detachChange(p);this._fallbackFetchAndBind()}else{g.detachChange(p)}}catch(e){g.detachChange(p);this._fallbackFetchAndBind()}}.bind(this);if(typeof g.attachChange==="function"){g.attachChange(p)}else{setTimeout(function(){this._fallbackFetchAndBind()}.bind(this),800)}},onParamNameFilterSelectionFinish:function(e){var t=e.getSource();var n=t.getSelectedItems();var a=n.map(function(e){return e.getKey()});var i=this.getView().byId("idDocTable");var r=i.getBinding("items");if(r){if(a.length>0){var o=a.map(function(e){return new sap.ui.model.Filter("parameterName",sap.ui.model.FilterOperator.EQ,e)});var s=new sap.ui.model.Filter(o,false);r.filter(s)}else{r.filter([])}}},onCustomerEditFilterSelectionFinish:function(e){var t=e.getSource();var n=t.getSelectedItems();var a=n.map(function(e){if(e.getKey()==="true"||e.getKey()===0){return true}else if(e.getKey()==="false"||e.getKey()===1){return false}return e.getKey()});var i=this.getView().byId("idDocTable");var r=i.getBinding("items");if(r){if(a.length>0){var o=a.map(function(e){return new sap.ui.model.Filter("isCustomerEditable",sap.ui.model.FilterOperator.EQ,e);aFinalFilters.push(new sap.ui.model.Filter({filters:o}))});var s=new sap.ui.model.Filter(o,false);r.filter(s)}else{r.filter([])}}},_fallbackFetchAndBind:async function(){var e=this.getView();var a=e.byId("idDocTable");if(!a){s.error("Table not found.");return}var i="isCustomerEditable eq true and (parameterName eq 'Application.Approvable.AllowApprovalOfDeniedApprovable' or parameterName eq 'Application.Approvable.AllowedForExternalApproval' )";var r=await this.oModel.bindContext("/generateDocument.generate(...)");r.invoke().then(async function(n){const i=r.getBoundContext().getObject();var o=new t({items:i.value});e.setModel(o,"docs");a.setBusy(false);var s=this.getView().getModel("docs");var l=s.getProperty("/items")||[];var d={};var c={};var u=l.reduce(function(e,t){var n=t.isCustomerEditable;if(n!==undefined&&!d[n]){d[n]=true;e.push({key:n,text:String(n)})}return e},[]);var f=await l.reduce(function(e,t){var n=t.parameterName;if(n!==undefined&&!c[n]){c[n]=true;e.push({key:n,text:String(n.replace(/\./g," "))})}return e},[]);var g=new sap.ui.model.json.JSONModel({customerEditableOptions:u,parameterNameOptions:f});this.getView().setModel(g,"filter")}.bind(this)).catch(function(i){s.error(i.message||"Failed to call generate function");var r=new t({items:[]});e.setModel(r,"docs");a.unbindItems();a.bindItems({path:"docs>/items",template:new n})}.bind(this))},onGeneratePress:async function(){this.byId("page").setBusy(true);const e={value:{docpayload:{projectName:this.byId("inpProjectName").getValue(),customerName:this.byId("inpCustomerName").getValue(),projectIdentification:[{label:"Project Name",value:this.byId("inpProjectName").getValue()},{label:"Customer Name",value:this.byId("inpCustomerName").getValue()},{label:"SAP Ariba Project Manager",value:this.byId("inpAribaPM").getValue()}],revisionHistory:[{author:this.byId("inpAribaPM").getValue(),version:"0.1",date:"2025-10-07T00:00:00Z",status:"Draft",location:"<Link to document>"}],businessProcessOverview:`This Project ${this.byId("inpProjectName").getValue()?this.byId("inpProjectName").getValue():"<Project Name>"} covers configuration between ${this.byId("inpCustomerName").getValue()?this.byId("inpCustomerName").getValue():"<Customer Name>"}  and SAP Ariba services...`,functionalOverview:`High-level description of the solution components...`,alternativesConsidered:`- Option A: ...\n- Option B: ...`,businessBenefit:`Expected cost savings and automated ordering...`,assumptions:`Customer provides X data; network access available.`,relationshipToOtherDocumentation:"See Leading Practice Functional Design Document for core details.",functionalDesign:"Detailed design of the RICEFWD objects, mapping, API calls...",constraints:["No changes to S/4 master data","Ariba API rate limits are 1000 calls/min"],tasksBySapAriba:[{task:"Develop connector",description:"Build and test the Ariba connector.",dependency:"Customer test data"}],tasksByCustomer:[],tasksByPartner:[],csvGuidedBuyingParameters:[],sapEditableParameters:[],customerEditableParameters:[]}}};var t="/generateDocument.combinedDocGenerate(...)";var n=await this.oModel.bindContext(t);Object.entries(e).forEach(([e,t])=>{n.setParameter(e,t)});await n.invoke();if(n.getBoundContext().getObject()){const e=n.getBoundContext().getObject();const t=this._bufferDownload(e);d.show("Document generated successfully.");this.byId("page").setBusy(false)}else{s.error("Document generation failed.");this.byId("page").setBusy(false)}let a="Ariba Config Document.docx"},_bufferDownload:async function(e,t="Project Functional Specification Document.docx",n="application/vnd.openxmlformats-officedocument.wordprocessingml.document"){{if(!e||!e.buffer){if(e&&e.fileMessage){s.information(e.fileMessage);this.byId("page").setBusy(false);return}else{throw new Error("No buffer found in payload")}}const a=e.buffer;let i;if(a instanceof ArrayBuffer){i=new Uint8Array(a);console.log(i)}else if(ArrayBuffer.isView(a)){i=new Uint8Array(a.buffer||a);console.log(i)}else if(a&&a.type==="Buffer"&&Array.isArray(a.data)){i=new Uint8Array(a.data);console.log(i)}else if(Array.isArray(a)){i=new Uint8Array(a);console.log(i)}else if(typeof a==="string"){const e=a.indexOf("base64,")>=0?a.split("base64,")[1]:a;const t=atob(e);const n=t.length;i=new Uint8Array(n);for(let e=0;e<n;e++){i[e]=t.charCodeAt(e)}}else if(a&&(a.data instanceof ArrayBuffer||Array.isArray(a.data)||ArrayBuffer.isView(a.data))){const e=a.data;if(e instanceof ArrayBuffer)i=new Uint8Array(e);else if(ArrayBuffer.isView(e))i=new Uint8Array(e.buffer);else i=new Uint8Array(e)}else{throw new Error("Unsupported buffer format: "+Object.prototype.toString.call(a))}const r=new Blob([i],{type:n});const o=URL.createObjectURL(r);const l=document.createElement("a");l.href=o;l.download=t;document.body.appendChild(l);l.click();this.byId("page").setBusy(false);l.remove();URL.revokeObjectURL(o)}}})});
//# sourceMappingURL=PrimaryView.controller.js.map